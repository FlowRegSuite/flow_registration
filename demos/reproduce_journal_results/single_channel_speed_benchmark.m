% Author   : Philipp Flotho
% Copyright 2021 by Philipp Flotho, All rights reserved.

% Estimation of the single channel runtime, 5 repetitions as reported in
% the paper
% (expect the second part to run at least 10 min!)
run('../../set_path.m');

input_file = 'data/injection_6hz.HDF';

vid = get_video_file_reader(input_file, 500, 1, 'dataset_names', 'ch1');
frames = vid.read_batch;
frames = frames(:, :, 1, :);

options = OF_options(...
    'input_file', input_file, ... % input path
    'quality_setting', 'fast', ...
    'reference_frames', 1:50 ...
    );

c_ref_raw = double(options.get_reference_frame(vid));
c_ref_raw = c_ref_raw(:, :, 1, :);
c_ref = mat2gray(imgaussfilt3_multichannel(mat2gray(c_ref_raw), ...
    options));
weight = [1.2, 0.8];
c1 = mat2gray(imgaussfilt3_multichannel(mat2gray(frames), ...
    options));

tic
for i = 1:5
    c_reg = compensate_sequence( ...
        c1, c_ref, ...
        frames, c_ref_raw, ...
        'sigma', 0.001, ...
        'weight', 1, ...
        'alpha', options.alpha, ...
        'levels', options.levels, ...
        'min_level', 6, ...
        'eta', options.eta, ...
        'update_lag', options.update_lag, ...
        'iterations', options.iterations, ...
        'a_smooth', options.a_smooth, 'a_data', options.a_data);
end
time_single = toc / 5;

tic
for i = 1:5
    c_reg = compensate_sequence( ...
        c1, c_ref, ...
        frames, c_ref_raw, ...
        'sigma', 0.001, ...
        'weight', 1, ...
        'alpha', options.alpha, ...
        'levels', options.levels, ...
        'eta', options.eta, ...
        'update_lag', options.update_lag, ...
        'iterations', options.iterations, ...
        'a_smooth', options.a_smooth, 'a_data', options.a_data);

end
time_full = toc / 5;

fprintf('fast setting took %f s\n', time_single);
fprintf('Full solution took %f s\n', time_full);